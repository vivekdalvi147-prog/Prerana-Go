<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prerana Go</title>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "50205842-082e-42e7-9b7f-958653483863",
          safari_web_id: "web.onesignal.auto.12345678", 
          notifyButton: { enable: true },
        });
      });
    </script>

    <style>
        /* --- 1. THEME VARIABLES & CORE STYLES --- */
        :root {
            /* DEFAULT: LIGHT MODE */
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --bg-panel: #f7f9fa;
            --text-main: #0f1419;
            --text-sec: #536471;
            --border: #eff3f4;
            
            /* Enhanced Gradients */
            --accent-grad: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
            --neon-blue: #007bff;
            --neon-purple: #6610f2;
            
            --chat-bg: #efe7dd;
            --msg-sent: #d9fdd3;
            --msg-recv: #ffffff;
            --msg-text-sent: #000;
            --msg-text-recv: #000;

            --danger: #ff3b30;
            --success: #34c759;
            --glass: rgba(0, 0, 0, 0.05);
            
            --radius: 18px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
        }

        /* CYBERPUNK DARK MODE */
        body.dark-mode {
            --bg-body: #000000;
            --bg-card: #16181c;
            --bg-panel: #202327;
            --text-main: #e7e9ea;
            --text-sec: #71767b;
            --border: #2f3336;
            
            --accent-grad: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            --neon-blue: #00d2ff;
            --neon-purple: #bc13fe;
            
            --chat-bg: #0b0b0b;
            --msg-sent: #005c4b;
            --msg-recv: #202c33;
            --msg-text-sent: #e9edef;
            --msg-text-recv: #e9edef;

            --danger: #f4212e;
            --success: #00ba7c;
            --glass: rgba(255, 255, 255, 0.08);
            --shadow: 0 0 25px rgba(0, 210, 255, 0.15);
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: var(--font); transition: background 0.3s ease, color 0.3s ease; }
        body { background-color: var(--bg-body); height: 100vh; display: flex; justify-content: center; overflow: hidden; color: var(--text-main); }

        /* --- 2. LAYOUT & UTILS --- */
        #app-root {
            width: 100%; max-width: 480px; background: var(--bg-body); height: 100%; 
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: var(--shadow); border-left: 1px solid var(--border); border-right: 1px solid var(--border);
        }

        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .center { justify-content: center; align-items: center; }
        .scroll-y { overflow-y: auto; scrollbar-width: none; }
        .scroll-y::-webkit-scrollbar { display: none; }

        /* Optimized Icons */
        .icon { width: 24px; height: 24px; stroke-width: 2.5; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; transition: transform 0.2s; }
        .icon:active { transform: scale(0.9); }
        .icon-sm { width: 18px; height: 18px; stroke-width: 2.5; }
        
        /* Loader */
        #main-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid var(--border); 
            border-top: 4px solid var(--neon-blue); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
            filter: drop-shadow(0 0 10px var(--neon-blue));
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #op-bar { height: 3px; background: var(--accent-grad); width: 0%; position: absolute; top: 0; left: 0; z-index: 1000; transition: width 0.4s ease-out; box-shadow: 0 2px 10px var(--neon-blue); }

        /* --- 3. CUSTOM MODAL (Improved) --- */
        #popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 10000; display: none; justify-content: center; align-items: center;
        }
        .popup-box {
            background: var(--bg-card); padding: 25px; border-radius: 24px; width: 85%; max-width: 320px;
            text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); 
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .popup-title { font-size: 20px; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
        .popup-msg { color: var(--text-sec); font-size: 15px; margin-bottom: 25px; line-height: 1.6; max-height: 60vh; overflow-y: auto; text-align: left; white-space: pre-wrap; }
        
        .btn-grad {
            background: var(--accent-grad); color: white; border: none; padding: 14px 24px; 
            border-radius: 30px; cursor: pointer; font-weight: 700; width: 100%; font-size: 15px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.25); transition: transform 0.1s, box-shadow 0.2s;
            letter-spacing: 0.5px;
        }
        .btn-grad:active { transform: scale(0.96); box-shadow: none; }
        .btn-danger { background: var(--danger) !important; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important; }
        .btn-ghost { background: transparent; color: var(--text-sec); border: 1px solid var(--border); box-shadow: none; margin-top: 10px; }

        /* --- 4. AUTH --- */
        #view-auth { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-body); z-index: 100; padding: 40px; 
            display: none; flex-direction: column; justify-content: center; text-align: center;
        }
        /* LOGO FIX */
        .logo-img { 
            width: 110px; height: 110px; border-radius: 24px; 
            margin: 0 auto 25px; object-fit: contain; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));
            background: transparent;
        }
        .auth-input { 
            width: 100%; padding: 16px; background: var(--bg-panel); border: 2px solid transparent; 
            border-radius: 16px; color: var(--text-main); font-size: 16px; margin-bottom: 15px; outline: none; 
            transition: border-color 0.3s, background 0.3s;
        }
        .auth-input:focus { border-color: var(--neon-blue); background: var(--bg-card); }
        .link-txt { color: var(--neon-blue); font-size: 14px; margin-top: 25px; cursor: pointer; font-weight: 600; }

        /* --- 5. MAIN UI --- */
        /* Header */
        header { 
            background: rgba(var(--bg-card), 0.9); backdrop-filter: blur(10px);
            padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--border); z-index: 50; height: 60px;
        }
        .app-logo-text { font-size: 22px; font-weight: 900; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        
        /* Side Menu */
        #side-menu {
            position: absolute; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%;
            background: var(--bg-card); z-index: 200; transform: translateX(-100%); 
            transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column;
            border-right: 1px solid var(--border); box-shadow: 20px 0 50px rgba(0,0,0,0.1);
        }
        #side-menu.open { transform: translateX(0); }
        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 190; display: none; }
        
        .menu-header { padding: 40px 25px; background: var(--bg-panel); border-bottom: 1px solid var(--border); }
        .menu-avatar-cont { width: 75px; height: 75px; margin-bottom: 15px; box-shadow: var(--shadow-sm); }
        .menu-item { padding: 16px 25px; display: flex; align-items: center; gap: 18px; color: var(--text-main); font-weight: 500; font-size: 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .menu-item:active { background: var(--bg-panel); }
        .menu-item svg { color: var(--text-sec); }
        
        /* Tabs */
        #view-container { flex: 1; overflow-y: auto; padding-bottom: 80px; background: var(--bg-body); position: relative; }
        .tab-view { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Slider */
        .slider-box { width: 92%; margin: 15px 4%; height: 190px; border-radius: 20px; overflow: hidden; position: relative; box-shadow: var(--shadow); border: 1px solid var(--border); background: #000; }
        .slide { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 0.8s; }
        .slide.active { opacity: 1; }

        /* Lists */
        .section-head { padding: 20px 15px 10px; font-size: 14px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .user-row { 
            display: flex; align-items: center; padding: 14px 15px; background: var(--bg-card); 
            margin-bottom: 1px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border); 
        }
        .user-row:active { background: var(--bg-panel); }
        .avatar { 
            width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; background: var(--bg-panel); 
            overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 20px; color: var(--text-sec);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Status Ring */
        .status-ring { padding: 3px; border: 2px solid transparent; background: linear-gradient(var(--bg-card), var(--bg-card)) padding-box, var(--accent-grad) border-box; }

        /* Posts */
        .post-card { background: var(--bg-card); padding: 18px; margin-bottom: 12px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .post-txt { font-size: 16px; color: var(--text-main); line-height: 1.5; margin-bottom: 12px; white-space: pre-wrap; word-break: break-word; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 5px; max-height: 400px; object-fit: cover; border: 1px solid var(--border); }
        .post-input { width: 100%; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 12px; margin-bottom: 10px; font-family: inherit; resize: none; }
        .post-input:focus { border-color: var(--neon-blue); outline: none; }
        
        /* Chat */
        #chat-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--chat-bg); z-index: 150; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1); }
        #chat-view.open { transform: translateX(0); }
        .chat-msgs { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; 
            background-image: radial-gradient(rgba(0,0,0,0.05) 1.5px, transparent 1.5px); background-size: 24px 24px; 
        }
        .msg { 
            max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 16px; position: relative; word-wrap: break-word; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); user-select: none;
        }
        .msg.sent { align-self: flex-end; background: var(--msg-sent); color: var(--msg-text-sent); border-top-right-radius: 2px; cursor: pointer; }
        .msg.received { align-self: flex-start; background: var(--msg-recv); color: var(--msg-text-recv); border-top-left-radius: 2px; border: 1px solid var(--border); }
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; font-size: 11px; opacity: 0.7; margin-top: 4px; }
        .chat-img-thumb { max-width: 220px; border-radius: 12px; margin-bottom: 5px; display: block; border: 1px solid rgba(0,0,0,0.1); }
        .chat-blocked-msg { padding: 15px; text-align: center; color: var(--danger); background: var(--bg-panel); font-size: 14px; border-top: 1px solid var(--border); }

        /* Navigation */
        nav { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 65px; 
            background: rgba(var(--bg-card), 0.95); border-top: 1px solid var(--border);
            display: flex; z-index: 50; backdrop-filter: blur(10px); padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { flex: 1; background: none; border: none; color: var(--text-sec); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; font-size: 10px; cursor: pointer; font-weight: 600; }
        .nav-btn.active { color: var(--neon-blue); }
        .nav-btn.active svg { stroke: var(--neon-blue); fill: rgba(0, 123, 255, 0.1); transform: scale(1.1); }

        /* Overlays (Status, Settings) */
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 180; overflow-y: auto; display: none; }
        .full-overlay.open { display: block; animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Status Viewer */
        #status-viewer { background: #000; display: none; flex-direction: column; position: fixed; z-index: 2000; inset: 0; }
        .progress-bar-container { display: flex; gap: 4px; padding: 12px; position: absolute; top: 0; width: 100%; z-index: 10; }
        .progress-segment { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; }
        .story-img { width: 100%; height: 100%; object-fit: contain; }

        /* Toggle Switch */
        .toggle-switch {
            width: 52px; height: 30px; background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 20px; position: relative; cursor: pointer; transition: background 0.3s;
        }
        .toggle-knob {
            width: 24px; height: 24px; background: white; border-radius: 50%;
            position: absolute; top: 2px; left: 2px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .active .toggle-switch { background: var(--accent-grad); }
        .active .toggle-knob { left: 24px; }

        /* Edit Dropdown */
        .kebab-menu { position: relative; padding: 5px; }
        .dropdown { position: absolute; right: 0; top: 30px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; width: 140px; display: none; z-index: 10; box-shadow: var(--shadow); overflow: hidden; animation: popIn 0.2s; }
        .dropdown div { padding: 12px; color: var(--text-main); cursor: pointer; font-size: 14px; font-weight: 500; }
        .dropdown div:hover { background: var(--bg-card); }

        /* Manufacturing / Maintenance Mode */
        #maintenance-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 20000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .maint-icon { width: 80px; height: 80px; color: var(--danger); margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Message Options Modal */
        #msg-opts-modal {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300;
             display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px);
        }
        .sheet-content {
            background: var(--bg-card); width: 100%; max-width: 480px; border-radius: 24px 24px 0 0;
            padding: 20px; animation: slideUp 0.2s;
        }
        .sheet-btn {
            width: 100%; padding: 15px; text-align: left; font-size: 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px; color: var(--text-main); font-weight: 500;
        }
        .sheet-btn:last-child { border-bottom: none; }
        .sheet-btn:active { background: var(--bg-panel); }

    </style>
</head>
<body>

    <div id="app-root">
        
        <!-- Global Loader -->
        <div id="main-loader"><div class="spinner"></div></div>
        <div id="op-bar"></div>

        <!-- Maintenance Screen -->
        <div id="maintenance-screen">
            <svg class="icon maint-icon"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <h2 class="app-logo-text">Under Maintenance</h2>
            <p style="color:var(--text-sec); margin-top:10px;">Prerana Go is currently in Manufacturing Mode. Please check back later.</p>
        </div>

        <!-- Custom Popup -->
        <div id="popup-overlay">
            <div class="popup-box">
                <div id="popup-title" class="popup-title">Alert</div>
                <div id="popup-msg" class="popup-msg">Message</div>
                <button class="btn-grad" onclick="closePopup()">Okay</button>
            </div>
        </div>

        <!-- Message Options Sheet (For Editing/Deleting Chat) -->
        <div id="msg-opts-modal" onclick="if(event.target === this) this.style.display='none'">
            <div class="sheet-content">
                <div style="font-size:12px; color:var(--text-sec); text-align:center; margin-bottom:10px;">Message Options</div>
                <div class="sheet-btn" onclick="triggerEditMsg()">
                    <svg class="icon-sm"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Edit Message
                </div>
                <div class="sheet-btn" style="color:var(--danger)" onclick="triggerDeleteMsg()">
                    <svg class="icon-sm"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Delete Message
                </div>
                <button class="btn-grad btn-ghost" style="margin-top:15px;" onclick="el('msg-opts-modal').style.display='none'">Cancel</button>
            </div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="view-auth">
            <img src="https://i.ibb.co/pkZfRJ0/In-Shot-20260120-211533519.png" class="logo-img" alt="Prerana Go Logo">
            <h1 class="app-logo-text" style="font-size:36px; margin-bottom:5px;">Prerana Go</h1>
            <p style="color:var(--text-sec); margin-bottom:35px; font-size:15px; font-weight:500;">Next-Gen Student Connect</p>

            <div id="auth-forms">
                <!-- Signup -->
                <div id="signup-form">
                    <input type="text" id="reg-name" class="auth-input" placeholder="Full Name">
                    <input type="email" id="reg-email" class="auth-input" placeholder="Email Address">
                    <input type="password" id="reg-pass" class="auth-input" placeholder="Password (Min 6 chars)">
                    <button class="btn-grad" onclick="handleSignup()">Create Account</button>
                    <div class="link-txt" onclick="toggleAuth('login')">Already registered? Login</div>
                </div>
                <!-- Login -->
                <div id="login-form" class="hidden">
                    <input type="email" id="log-email" class="auth-input" placeholder="Email Address">
                    <input type="password" id="log-pass" class="auth-input" placeholder="Password">
                    <button class="btn-grad" onclick="handleLogin()">Access System</button>
                    <div class="link-txt" onclick="toggleAuth('signup')">Create new account</div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR MENU -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
        <div id="side-menu">
            <div class="menu-header">
                <div class="menu-avatar-cont avatar" id="menu-avatar"></div>
                <h3 id="menu-name" style="color:var(--text-main); margin-bottom:4px; font-size:20px;">User</h3>
                <div id="menu-id" style="color:var(--neon-blue); font-size:13px; font-weight:600;">ID: --</div>
            </div>
            
            <div class="menu-item" onclick="openRequestsView()">
                <svg class="icon"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                Friend Requests <span id="req-count" style="margin-left:auto; background:var(--danger); color:white; font-size:11px; padding:3px 8px; border-radius:10px; display:none;">0</span>
            </div>
            <div class="menu-item" onclick="toggleSettings(true)">
                <svg class="icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </div>
            
            <a href="https://bol-ai.vercel.app" target="_blank" style="text-decoration:none;">
                <div class="menu-item">
                    <svg class="icon" style="color:var(--neon-blue)"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    Ask with Vivek's AI
                </div>
            </a>

            <div style="margin-top:auto; border-top:1px solid var(--border);">
                <div class="menu-item" onclick="openAbout()">
                    <svg class="icon"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    About Us
                </div>
                 <div class="menu-item" onclick="openPrivacy()">
                    <svg class="icon"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    Privacy Policy
                </div>
                <div class="menu-item" onclick="handleLogout()" style="color:var(--danger)">
                    <svg class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </div>
            </div>
        </div>

        <!-- MAIN HEADER -->
        <header id="main-header" class="hidden">
            <div class="flex" style="gap:15px;">
                <div onclick="toggleMenu()" style="cursor:pointer; position:relative; padding:5px;">
                    <svg class="icon"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    <div id="menu-dot" style="position:absolute;top:2px;right:2px;width:10px;height:10px;background:var(--danger);border-radius:50%;display:none;border:2px solid var(--bg-card);"></div>
                </div>
                <div class="app-logo-text">Prerana Go</div>
            </div>
            <div id="header-av" class="avatar" style="width:36px;height:36px;border:2px solid var(--neon-blue);margin:0;box-shadow:0 0 10px rgba(0, 123, 255, 0.3);"></div>
        </header>

        <!-- APP CONTENT -->
        <div id="view-container" class="hidden">
            
            <!-- HOME TAB -->
            <div id="tab-home" class="tab-view active">
                <div class="slider-box" id="slider-box"></div>
                
                <div class="section-head">Find Students</div>
                <div style="padding:0 15px 15px;">
                    <div style="background:var(--bg-panel); padding:12px; border-radius:15px; display:flex; align-items:center; border:1px solid var(--border); box-shadow:inset 0 2px 4px rgba(0,0,0,0.02);">
                        <svg class="icon-sm" style="color:var(--text-sec)"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="search-input" placeholder="Search by Name or Prerana ID..." style="background:none; border:none; color:var(--text-main); margin-left:12px; flex:1; outline:none; font-size:15px;" onkeyup="searchUsers()">
                    </div>
                </div>
                <div id="search-list"></div>

                <div class="section-head">Announcements</div>
                <div id="ann-list" style="padding:0 15px;"></div>
            </div>

            <!-- STATUS TAB -->
            <div id="tab-status" class="tab-view">
                <div class="user-row" onclick="el('status-inp').click()">
                    <div class="avatar" id="my-status-av" style="position:relative; border-style:dashed; border-color:var(--neon-blue);"></div>
                    <div>
                        <div style="color:var(--text-main); font-weight:700;">My Status</div>
                        <div style="color:var(--text-sec); font-size:13px;">Tap to add update</div>
                    </div>
                    <svg class="icon" style="margin-left:auto; color:var(--neon-blue);"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                </div>
                <input type="file" id="status-inp" hidden accept="image/*" onchange="uploadStatus(this)">
                
                <div class="section-head">Recent Updates</div>
                <div id="status-list"></div>
            </div>

            <!-- POSTS TAB -->
            <div id="tab-posts" class="tab-view">
                <!-- Post Search Bar -->
                <div style="padding:10px 15px 0;">
                     <div style="background:var(--bg-panel); padding:10px 14px; border-radius:15px; display:flex; align-items:center; border:1px solid var(--border);">
                        <svg class="icon-sm" style="color:var(--text-sec)"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="post-search" placeholder="Filter posts..." style="background:none; border:none; color:var(--text-main); margin-left:10px; flex:1; outline:none;" onkeyup="filterPosts(this.value)">
                    </div>
                </div>

                <div style="padding:15px; border-bottom:1px solid var(--border); background:var(--bg-card); margin-top:10px;">
                    <textarea id="post-text" class="post-input" rows="3" placeholder="What's happening?"></textarea>
                    <div class="flex" style="justify-content:space-between;">
                        <div onclick="el('post-file').click()" style="color:var(--neon-blue); cursor:pointer; font-size:14px; display:flex; align-items:center; gap:6px; font-weight:600; padding:5px;">
                            <svg class="icon-sm"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            Add Photo
                        </div>
                        <button class="btn-grad" style="width:auto; padding:8px 24px; font-size:13px;" onclick="createPost()">Post</button>
                    </div>
                    <div id="post-file-name" style="font-size:12px; color:var(--success); margin-top:5px; font-weight:bold;"></div>
                    <input type="file" id="post-file" hidden accept="image/*" onchange="el('post-file-name').innerText='Image Selected'">
                </div>
                <div id="posts-feed" style="background:var(--bg-panel); min-height:500px; padding-top:10px;"></div>
            </div>

            <!-- FRIENDS TAB -->
            <div id="tab-friends" class="tab-view">
                <div id="friends-list"></div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav id="main-nav" class="hidden">
            <button class="nav-btn active" onclick="switchTab('home')">
                <svg class="icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Home
            </button>
            <button class="nav-btn" onclick="switchTab('status')">
                <svg class="icon"><circle cx="12" cy="12" r="10"></circle><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06M14.31 16H2.83m13.79-4l-5.74 9.94"></path></svg>
                Status
            </button>
            <button class="nav-btn" onclick="switchTab('posts')">
                <svg class="icon"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                Posts
            </button>
            <button class="nav-btn" onclick="switchTab('friends')">
                <svg class="icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Friends
            </button>
        </nav>

        <!-- FULL PAGE OVERLAYS -->
        
        <!-- Requests View -->
        <div id="view-requests" class="full-overlay">
            <div class="flex" style="padding:15px; border-bottom:1px solid var(--border); background:var(--bg-card);">
                <div onclick="closeRequestsView()" style="margin-right:15px; padding:5px;"><svg class="icon"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></div>
                <div style="font-weight:800; font-size:18px;">Friend Requests</div>
            </div>
            <div id="req-list" style="padding:10px;"></div>
        </div>

        <!-- Settings View -->
        <div id="view-settings" class="full-overlay">
            <div class="flex" style="padding:15px; border-bottom:1px solid var(--border); background:var(--bg-card);">
                <div onclick="toggleSettings(false)" style="margin-right:15px; padding:5px;"><svg class="icon"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></div>
                <div style="font-weight:800; font-size:18px;">Settings</div>
            </div>
            <div style="padding:30px; text-align:center;">
                <div class="avatar" style="width:110px; height:110px; margin:0 auto 20px; font-size:40px; border:3px solid var(--neon-blue); box-shadow: 0 5px 15px rgba(0,0,0,0.1);" id="set-av"></div>
                <button class="btn-grad" style="width:auto; padding:10px 30px; font-size:13px;" onclick="el('pfp-inp').click()">Change Profile Photo</button>
                <input type="file" id="pfp-inp" hidden accept="image/*" onchange="updatePfp(this)">
            </div>
            <div style="padding:20px;">
                <div style="margin-bottom:25px; display:flex; justify-content:space-between; align-items:center; background:var(--bg-card); padding:15px; border-radius:12px; border:1px solid var(--border);">
                    <div>
                        <div style="font-weight:600; font-size:15px;">Cyberpunk Mode</div>
                        <div style="font-size:12px; color:var(--text-sec);">Dark futuristic theme</div>
                    </div>
                    <div id="theme-toggle" class="toggle-switch" onclick="switchTheme()">
                        <div class="toggle-knob"></div>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:var(--text-sec); font-size:13px; font-weight:600; margin-left:5px;">Education / Bio</label>
                    <input type="text" id="set-edu" class="auth-input" onblur="updateField('education', this.value)" style="margin-top:5px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="color:var(--text-sec); font-size:13px; font-weight:600; margin-left:5px;">Auto Delete Messages</label>
                    <select id="set-del" class="auth-input" onchange="updateField('autoDelete', this.value)" style="margin-top:5px;">
                        <option value="0">Never</option>
                        <option value="12">After 12 Hours</option>
                        <option value="24">After 24 Hours</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Status Viewer -->
        <div id="status-viewer">
            <div class="progress-bar-container" id="st-progress"></div>
            <div style="position:absolute; top:25px; left:0; width:100%; display:flex; padding:0 15px; align-items:center; z-index:20;">
                <div onclick="closeStatusViewer()" style="padding:5px;"><svg class="icon" style="color:white; filter:drop-shadow(0 0 3px black);"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></div>
                <div class="avatar" style="width:40px;height:40px;margin:0 10px; background:none; border:2px solid white;" id="st-view-av"></div>
                <div>
                    <div id="st-view-name" style="font-weight:800; color:white; text-shadow:0 1px 3px black; font-size:15px;">Name</div>
                    <div id="st-view-time" style="font-size:12px; color:rgba(255,255,255,0.9); text-shadow:0 1px 3px black;">Time</div>
                </div>
                <div id="st-del-btn" style="margin-left:auto; display:none; padding:10px;" onclick="deleteCurrentStatus()">
                    <svg class="icon" style="color:var(--danger); filter:drop-shadow(0 0 2px black);"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </div>
            </div>
            <div style="flex:1; position:relative; display:flex; align-items:center; justify-content:center; height:100%; width:100%; background:black;">
                 <div style="position:absolute; left:0; width:30%; height:100%; z-index:15;" onclick="prevStory()"></div>
                 <div style="position:absolute; right:0; width:30%; height:100%; z-index:15;" onclick="nextStory()"></div>
                 <img id="st-view-img" class="story-img">
                 <div id="st-loader" class="spinner" style="position:absolute;"></div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view">
            <div style="padding:10px 15px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; box-shadow: var(--shadow-sm);">
                <div onclick="closeChat()" style="padding:5px;"><svg class="icon"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></div>
                <div class="avatar" style="width:40px; height:40px; margin:0 12px; border:none;" id="chat-av"></div>
                <div style="flex:1;">
                    <div id="chat-name" style="font-weight:800; font-size:16px; color:var(--text-main);">User</div>
                    <div id="chat-status" style="font-size:12px; color:var(--neon-blue); font-weight:500;">Offline</div>
                </div>
                <!-- Block Button -->
                <div id="block-btn-cont" style="margin-left:auto;">
                    <div class="kebab-menu" onclick="el('chat-menu').style.display = el('chat-menu').style.display === 'block' ? 'none' : 'block'">
                        <svg class="icon"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                        <div id="chat-menu" class="dropdown">
                            <div id="block-text" onclick="toggleBlock()" style="color:var(--danger)">Block User</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-msgs" id="chat-msgs"></div>
            
            <!-- Chat Footer -->
            <div id="chat-footer" style="padding:10px 15px; background:var(--bg-panel); display:flex; align-items:center; gap:10px; border-top:1px solid var(--border); padding-bottom: calc(10px + env(safe-area-inset-bottom));">
                <div onclick="el('chat-file-inp').click()" style="padding:5px;">
                    <svg class="icon" style="color:var(--text-sec); cursor:pointer;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </div>
                <input type="file" id="chat-file-inp" hidden accept="image/*" onchange="sendChatImage(this)">
                
                <input type="text" id="chat-input" class="post-input" style="margin:0; border-radius:24px; background:var(--bg-card); border:none; padding:12px 15px;" placeholder="Type a message...">
                <button onclick="sendMsg()" style="background:var(--accent-grad); border:none; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.2); flex-shrink:0;">
                    <svg class="icon" style="color:white; transform:rotate(45deg); margin-left:-3px; margin-top:2px;"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <div id="chat-blocked-view" class="chat-blocked-msg hidden">
                You cannot send messages to this user.
            </div>
        </div>

        <!-- Edit Post Modal -->
        <div id="edit-modal" class="full-overlay" style="background:rgba(0,0,0,0.8); z-index:250; justify-content:center; align-items:center; display:none;">
            <div class="popup-box" style="margin:auto; margin-top:100px;">
                <h3 style="margin-bottom:15px; color:var(--neon-blue)">Edit Text</h3>
                <textarea id="edit-txt" class="post-input" rows="5"></textarea>
                <div class="flex" style="gap:10px; margin-top:15px;">
                    <button class="btn-grad" style="background:var(--bg-panel); color:var(--text-main); box-shadow:none; border:1px solid var(--border);" onclick="el('edit-modal').style.display='none'">Cancel</button>
                    <button class="btn-grad" onclick="savePostEdit()">Save Changes</button>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyClq3WavwvWqSOQl28QZQq96h_Ihg8X3YY",
            authDomain: "prerana-go.firebaseapp.com",
            projectId: "prerana-go",
            storageBucket: "prerana-go.firebasestorage.app",
            messagingSenderId: "986723238308",
            appId: "1:986723238308:web:a906d0b56bf0c575acc131"
        };
        const IMGBB_KEY = "82d4d559eff443cbe1d4698823e50da5";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null, userData = null, chatUnsub = null, currentChatId = null, currentChatUid = null;
        let storyGroups = {}, currentStoryUid = null, storyIdx = 0, storyTimer = null, isPaused = false;
        let editPostId = null;
        let maintenanceUnsub = null;
        
        // Chat Edit State
        let selectedMsgId = null;
        let selectedMsgText = null;

        const el = (id) => document.getElementById(id);
        const showLoad = () => el('main-loader').classList.remove('hidden');
        const hideLoad = () => el('main-loader').classList.add('hidden');
        const showBar = () => el('op-bar').style.width = '70%';
        const hideBar = () => el('op-bar').style.width = '0%';
        
        // Custom Popup (Replaces Alert)
        window.showPopup = (t, m) => { 
            el('popup-title').innerText = t; 
            el('popup-msg').innerText = m; 
            el('popup-overlay').style.display = 'flex'; 
        };
        window.closePopup = () => el('popup-overlay').style.display = 'none';
        window.el = el;

        // --- AUTH ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                el('view-auth').style.display = 'none';
                el('main-header').classList.remove('hidden');
                el('main-nav').classList.remove('hidden');
                el('view-container').classList.remove('hidden');
                
                // Fetch User
                const snap = await getDoc(doc(db, "users", u.uid));
                if (snap.exists()) {
                    userData = snap.data();
                    initApp();
                } else {
                    signOut(auth);
                }
            } else {
                currentUser = null;
                el('view-auth').style.display = 'flex';
                el('main-header').classList.add('hidden');
                el('main-nav').classList.add('hidden');
                el('view-container').classList.add('hidden');
            }
            hideLoad();
        });

        window.toggleAuth = (m) => {
            el('signup-form').classList.toggle('hidden', m==='login');
            el('login-form').classList.toggle('hidden', m==='signup');
        };

        window.handleSignup = async () => {
            const n=el('reg-name').value, e=el('reg-email').value, p=el('reg-pass').value;
            if(!n||!e||!p) return showPopup('Error','Please fill all fields.');
            if(p.length<6) return showPopup('Weak Password', 'Password must be at least 6 characters.');
            showBar();
            try {
                const c = await createUserWithEmailAndPassword(auth, e, p);
                const pid = Math.floor(10000+Math.random()*90000).toString();
                await setDoc(doc(db, "users", c.user.uid), {
                    uid: c.user.uid, name: n, email: e, preranaId: pid,
                    photoURL: '', friends: [], requests: [], blocked: [], 
                    education: '', autoDelete: "0", isOnline: true, lastSeen: serverTimestamp()
                });
            } catch(x) { showPopup('Error', x.message.replace('Firebase:', '')); }
            hideBar();
        };

        window.handleLogin = async () => {
            const e = el('log-email').value; const p = el('log-pass').value;
            if(!e || !p) return showPopup('Error', 'Enter email and password.');
            showBar();
            try { await signInWithEmailAndPassword(auth, e, p); }
            catch(x) { showPopup('Authentication Failed','Invalid Credentials or User not found.'); }
            hideBar();
        };

        window.handleLogout = async () => {
            if(currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { isOnline: false, lastSeen: serverTimestamp() });
            }
            if(maintenanceUnsub) maintenanceUnsub();
            signOut(auth);
            location.reload();
        };

        // --- INIT & THEME ---
        function initApp() {
            // Manufacturing Mode Listener
            maintenanceUnsub = onSnapshot(doc(db, "settings", "config"), (doc) => {
                if (doc.exists() && doc.data().maintenance) {
                    el('maintenance-screen').style.display = 'flex';
                } else {
                    el('maintenance-screen').style.display = 'none';
                }
            });

            // Sidebar Data
            el('menu-name').innerText = userData.name;
            el('menu-id').innerText = `Prerana ID: ${userData.preranaId}`;
            renderPfp('menu-avatar', userData.photoURL, userData.name);
            renderPfp('header-av', userData.photoURL, userData.name);
            renderPfp('set-av', userData.photoURL, userData.name);
            renderPfp('my-status-av', userData.photoURL, userData.name);
            
            el('set-edu').value = userData.education || "";
            el('set-del').value = userData.autoDelete || "0";

            // Online Tracking
            updateDoc(doc(db, "users", currentUser.uid), { isOnline: true, lastSeen: serverTimestamp() });
            setInterval(() => updateDoc(doc(db, "users", currentUser.uid), { lastSeen: serverTimestamp() }), 60000);

            // OneSignal: Get Player ID and Save to Firestore (IMPROVED)
            if(window.OneSignalDeferred) {
                window.OneSignalDeferred.push(async function(OneSignal) {
                    try {
                        // FORCE LOGIN to associate external ID
                        await OneSignal.login(currentUser.uid);

                        // Save ID Function
                        const saveOneSignalId = async () => {
                             const id = OneSignal.User.PushSubscription.id;
                             if(id) {
                                 console.log("Saving OneSignal ID:", id);
                                 await updateDoc(doc(db, "users", currentUser.uid), { oneSignalId: id });
                             }
                        };

                        // 1. Try Saving Immediately
                        await saveOneSignalId();

                        // 2. Listen for Subscription Changes (if user grants permission later)
                        OneSignal.User.PushSubscription.addEventListener("change", async (e) => {
                           if (e.current.id) {
                               await updateDoc(doc(db, "users", currentUser.uid), { oneSignalId: e.current.id });
                           }
                        });
                    } catch(e) { console.log("Push init error", e); }
                });
            }

            // Listeners
            listenRequests();
            loadHome();
            loadStatuses();
            loadPosts();
            loadFriends();
        }

        window.switchTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            el('theme-toggle').classList.toggle('active', isDark);
        };

        function renderPfp(id, url, name) {
            const elem = el(id);
            if(url) {
                elem.innerHTML = `<img src="${url}">`;
            } else {
                const initial = name ? name.charAt(0).toUpperCase() : '?';
                elem.innerHTML = `<div style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:var(--bg-panel);color:var(--text-main);font-size:inherit;">${initial}</div>`;
            }
        }

        // --- NAVIGATION ---
        window.toggleMenu = () => {
            el('side-menu').classList.toggle('open');
            el('menu-overlay').style.display = el('side-menu').classList.contains('open')?'block':'none';
        };
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-view').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            el('tab-'+t).classList.add('active');
            const map = {home:0, status:1, posts:2, friends:3};
            document.querySelectorAll('.nav-btn')[map[t]].classList.add('active');
        };

        // --- REQUESTS ---
        function listenRequests() {
            onSnapshot(doc(db,"users",currentUser.uid), (s) => {
                userData = s.data();
                const count = (userData.requests||[]).length;
                el('req-count').innerText = count;
                el('req-count').style.display = count>0 ? 'inline-block' : 'none';
                el('menu-dot').style.display = count>0 ? 'block' : 'none';
            });
        }
        window.openRequestsView = async () => {
            toggleMenu();
            el('view-requests').classList.add('open');
            const list = el('req-list');
            list.innerHTML = '';
            const reqs = userData.requests || [];
            if(reqs.length === 0) list.innerHTML = '<p style="color:var(--text-sec);text-align:center;margin-top:20px;">No pending requests.</p>';
            
            for(const uid of reqs) {
                const u = (await getDoc(doc(db,"users",uid))).data();
                list.innerHTML += `
                    <div class="user-row">
                        <div class="avatar">${u.photoURL ? `<img src="${u.photoURL}">` : u.name[0]}</div>
                        <div style="flex:1;">
                            <div style="color:var(--text-main);font-weight:bold;">${u.name}</div>
                        </div>
                        <div class="flex" style="gap:8px;">
                            <button class="btn-grad" style="padding:6px 16px;font-size:12px;width:auto;" onclick="ansReq('${uid}',true)">Accept</button>
                            <button class="btn-grad" style="padding:6px 16px;font-size:12px;background:var(--bg-panel);color:var(--text-main);box-shadow:none;border:1px solid var(--border);width:auto;" onclick="ansReq('${uid}',false)">Reject</button>
                        </div>
                    </div>`;
            }
        };
        window.closeRequestsView = () => el('view-requests').classList.remove('open');
        window.ansReq = async (uid, acc) => {
            await updateDoc(doc(db,"users",currentUser.uid),{requests: arrayRemove(uid)});
            if(acc) {
                await updateDoc(doc(db,"users",currentUser.uid),{friends: arrayUnion(uid)});
                await updateDoc(doc(db,"users",uid),{friends: arrayUnion(currentUser.uid)});
            }
            openRequestsView();
        };

        // --- STATUS LOGIC ---
        window.uploadStatus = async (inp) => {
            if(inp.files[0]) {
                showBar();
                const url = await uploadImg(inp.files[0]);
                if(url) {
                    await addDoc(collection(db,"statuses"), { uid:currentUser.uid, imageUrl:url, timestamp: serverTimestamp() });
                    showPopup("Success","Status Updated");
                    loadStatuses();
                }
                hideBar();
            }
        };

        async function loadStatuses() {
            const list = el('status-list');
            list.innerHTML = '';
            
            const yest = new Date(Date.now() - 24*3600*1000);
            
            const q = query(collection(db,"statuses"), where("timestamp",">",yest), orderBy("timestamp","asc"));
            const snaps = await getDocs(q);
            
            storyGroups = {}; 
            
            snaps.forEach(d => {
                const s = d.data();
                s.id = d.id;
                // Check friendship or self
                if(userData.friends.includes(s.uid) || s.uid === currentUser.uid) {
                    if(!storyGroups[s.uid]) storyGroups[s.uid] = [];
                    storyGroups[s.uid].push(s);
                }
            });

            if(Object.keys(storyGroups).length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sec)'>No recent updates from friends.</div>";
                return;
            }

            for(const uid in storyGroups) {
                const uDoc = await getDoc(doc(db,"users",uid));
                if(uDoc.exists()){
                    const u = uDoc.data();
                    const stories = storyGroups[uid];
                    
                    const div = document.createElement('div');
                    div.className = 'user-row';
                    div.innerHTML = `
                        <div class="avatar status-ring">${u.photoURL ? `<img src="${u.photoURL}">` : u.name[0]}</div>
                        <div>
                            <div style="color:var(--text-main);font-weight:700;">${u.name}</div>
                            <div style="color:var(--text-sec);font-size:12px;">${stories.length} new update(s)</div>
                        </div>`;
                    div.onclick = () => openStoryViewer(uid, stories, u);
                    list.appendChild(div);
                }
            }
        }

        window.openStoryViewer = (uid, stories, user) => {
            currentStoryUid = uid;
            storyIdx = 0;
            isPaused = false;
            
            el('status-viewer').style.display = 'flex';
            renderPfp('st-view-av', user.photoURL, user.name);
            el('st-view-name').innerText = user.name;
            
            renderStory(stories);
            
            const view = el('status-viewer');
            view.onmousedown = view.ontouchstart = () => { isPaused = true; };
            view.onmouseup = view.ontouchend = () => { isPaused = false; };
        };

        function renderStory(stories) {
            if(storyIdx >= stories.length) { closeStatusViewer(); return; }
            if(storyIdx < 0) storyIdx = 0;

            const s = stories[storyIdx];
            const img = el('st-view-img');
            const loader = el('st-loader');
            
            loader.style.display = 'block';
            img.style.opacity = 0;
            img.src = s.imageUrl;
            
            img.onload = () => {
                loader.style.display = 'none';
                img.style.opacity = 1;
            };

            el('st-view-time').innerText = new Date(s.timestamp.toDate()).toLocaleTimeString();
            
            // Bars
            const barCont = el('st-progress');
            barCont.innerHTML = '';
            stories.forEach((_, i) => {
                const seg = document.createElement('div');
                seg.className = 'progress-segment';
                seg.innerHTML = `<div class="progress-fill" style="width:${i<storyIdx?'100%':'0%'}"></div>`;
                if(i === storyIdx) seg.querySelector('.progress-fill').id = 'active-fill';
                barCont.appendChild(seg);
            });

            el('st-del-btn').style.display = (s.uid === currentUser.uid) ? 'block' : 'none';

            if(storyTimer) clearInterval(storyTimer);
            let progress = 0;
            storyTimer = setInterval(() => {
                if(!isPaused) {
                    progress += 1.5; 
                    const fill = el('active-fill');
                    if(fill) fill.style.width = progress + '%';
                    if(progress >= 100) {
                        storyIdx++;
                        renderStory(stories);
                    }
                }
            }, 30);
        }

        window.prevStory = () => { if(storyIdx > 0) { storyIdx--; renderStory(storyGroups[currentStoryUid]); } };
        window.nextStory = () => { storyIdx++; renderStory(storyGroups[currentStoryUid]); };
        window.closeStatusViewer = () => { el('status-viewer').style.display = 'none'; if(storyTimer) clearInterval(storyTimer); };
        window.deleteCurrentStatus = async () => {
            const stories = storyGroups[currentStoryUid];
            const s = stories[storyIdx];
            await deleteDoc(doc(db, "statuses", s.id));
            closeStatusViewer();
            loadStatuses();
        };

        // --- POSTS ---
        async function loadPosts() {
            const feed = el('posts-feed');
            feed.innerHTML = '';
            const q = query(collection(db,"posts"), orderBy("timestamp","desc"), limit(20));
            const snaps = await getDocs(q);
            
            snaps.forEach(async d => {
                const p = d.data();
                const uDoc = await getDoc(doc(db,"users",p.uid));
                if(uDoc.exists()){
                    const u = uDoc.data();
                    const isMine = p.uid === currentUser.uid;
                    const menu = isMine ? `
                        <div class="kebab-menu" onclick="togglePostMenu('${d.id}')">
                            <svg class="icon"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                            <div id="pm-${d.id}" class="dropdown">
                                <div onclick="editPost('${d.id}', '${p.text ? p.text.replace(/'/g, "\\'") : ''}')">Edit</div>
                                <div onclick="deletePost('${d.id}')" style="color:var(--danger)">Delete</div>
                            </div>
                        </div>` : '';

                    const div = document.createElement('div');
                    div.className = 'post-card';
                    div.innerHTML = `
                        <div class="post-header">
                            <div class="flex">
                                <div class="avatar" style="width:40px;height:40px;">${u.photoURL ? `<img src="${u.photoURL}">` : u.name[0]}</div>
                                <div>
                                    <div style="color:var(--text-main);font-weight:bold;">${u.name}</div>
                                    <div style="color:var(--text-sec);font-size:12px;">${p.timestamp?new Date(p.timestamp.toDate()).toLocaleDateString():'Just now'}</div>
                                </div>
                            </div>
                            ${menu}
                        </div>
                        <div class="post-txt">${p.text || ''}</div>
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-img">` : ''}
                    `;
                    feed.appendChild(div);
                }
            });
        }
        
        // Post Search Filter
        window.filterPosts = (txt) => {
            txt = txt.toLowerCase();
            const cards = document.querySelectorAll('.post-card');
            cards.forEach(card => {
                const content = card.innerText.toLowerCase();
                card.style.display = content.includes(txt) ? 'block' : 'none';
            });
        };

        window.togglePostMenu = (id) => { const m = el('pm-'+id); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
        window.createPost = async () => {
            const t = el('post-text').value;
            const f = el('post-file').files[0];
            if(!t && !f) return showPopup("Empty", "Add text or image");
            showBar();
            let url = "";
            if(f) url = await uploadImg(f);
            await addDoc(collection(db,"posts"), { uid:currentUser.uid, text:t, imageUrl:url, timestamp:serverTimestamp() });
            el('post-text').value=''; el('post-file').value=''; el('post-file-name').innerText='';
            loadPosts();
            hideBar();
        };
        window.deletePost = async (pid) => { if(confirm("Delete this post?")) { await deleteDoc(doc(db,"posts",pid)); loadPosts(); } };
        window.editPost = (pid, text) => { 
            editPostId = pid; 
            // We use the same edit-modal logic for posts, but set a flag for which function to save
            el('edit-txt').value = text; 
            el('edit-modal').style.display = 'flex'; 
            window.isEditingPost = true; // Flag
        };
        
        // Unified Save Function (Checks if saving post or message)
        window.savePostEdit = async () => { 
            const newTxt = el('edit-txt').value;
            if(window.isEditingPost) {
                await updateDoc(doc(db,"posts",editPostId), { text: newTxt }); 
                el('edit-modal').style.display = 'none'; 
                loadPosts();
            } else {
                // Editing Message
                 await updateDoc(doc(db,"chats",currentChatId,"messages",selectedMsgId), { text: newTxt });
                 el('edit-modal').style.display = 'none';
            }
        };

        // --- CHAT SYSTEM (WITH BLOCKING & EDIT/DELETE) ---
        window.openChat = async (uid) => {
            currentChatUid = uid;
            
            // Check Block Status
            const otherUserSnap = await getDoc(doc(db, "users", uid));
            const myUserSnap = await getDoc(doc(db, "users", currentUser.uid));
            
            if (!otherUserSnap.exists()) return;
            const u = otherUserSnap.data();
            const me = myUserSnap.data();

            renderPfp('chat-av', u.photoURL, u.name);
            el('chat-name').innerText = u.name;
            el('chat-status').innerText = u.isOnline ? "Online" : "Offline";
            el('chat-status').style.color = u.isOnline ? "var(--neon-blue)" : "var(--text-sec)";
            el('chat-menu').style.display = 'none';

            // Check if I blocked them
            const iBlockedThem = (me.blocked || []).includes(uid);
            // Check if they blocked me
            const theyBlockedMe = (u.blocked || []).includes(currentUser.uid);

            const isBlocked = iBlockedThem || theyBlockedMe;
            
            // Update UI for Block
            el('block-text').innerText = iBlockedThem ? "Unblock User" : "Block User";
            el('chat-footer').classList.toggle('hidden', isBlocked);
            el('chat-blocked-view').classList.toggle('hidden', !isBlocked);
            if(isBlocked) el('chat-blocked-view').innerText = iBlockedThem ? "You blocked this user." : "This user is unavailable.";

            currentChatId = [currentUser.uid, uid].sort().join('_');
            el('chat-view').classList.add('open');
            
            if(chatUnsub) chatUnsub();
            const q = query(collection(db,"chats",currentChatId,"messages"), orderBy("timestamp","asc"));
            chatUnsub = onSnapshot(q, (s) => {
                const b = el('chat-msgs'); b.innerHTML='';
                s.forEach(d => {
                    const m = d.data();
                    if(!m.read && m.sender !== currentUser.uid) {
                        updateDoc(d.ref, {read: true});
                    }
                    const isMe = m.sender === currentUser.uid;
                    let ticks = "";
                    if(isMe) {
                        const col = m.read ? "var(--neon-blue)" : "var(--text-sec)";
                        ticks = `<svg class="icon" style="width:14px;height:14px;color:${col}"><path d="M18 6L7 17l-5-5"></path><path d="M22 10l-7.5 7.5L13 16"></path></svg>`;
                    }
                    let content = m.type === 'image' ? `<img src="${m.imageUrl}" class="chat-img-thumb" onclick="window.open('${m.imageUrl}','_blank')">` : m.text;
                    
                    // Add click handler for options if it's my message
                    const clickAction = isMe ? `onclick="openMsgOptions('${d.id}', '${m.type==='text'?m.text.replace(/'/g, "\\'"):'image'}')"` : '';
                    
                    b.innerHTML += `
                        <div class="msg ${isMe?'sent':'received'}" ${clickAction}>
                            ${content}
                            <div class="msg-meta">
                                ${m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'} 
                                ${ticks}
                            </div>
                        </div>`;
                });
                b.scrollTop = b.scrollHeight;
            });
        };
        
        window.closeChat = () => { el('chat-view').classList.remove('open'); if(chatUnsub) chatUnsub(); currentChatUid = null; };
        
        // Chat Message Options (Edit/Delete)
        window.openMsgOptions = (id, textOrType) => {
            selectedMsgId = id;
            selectedMsgText = textOrType;
            // Only show edit if it's text
            el('msg-opts-modal').querySelector('.sheet-btn').style.display = (textOrType === 'image') ? 'none' : 'flex';
            el('msg-opts-modal').style.display = 'flex';
        };

        window.triggerEditMsg = () => {
            el('msg-opts-modal').style.display = 'none';
            window.isEditingPost = false; // Flag for message editing
            el('edit-txt').value = selectedMsgText;
            el('edit-modal').style.display = 'flex';
            el('edit-modal').querySelector('h3').innerText = "Edit Message";
        };

        window.triggerDeleteMsg = async () => {
            el('msg-opts-modal').style.display = 'none';
            if(confirm("Delete this message?")) {
                await deleteDoc(doc(db,"chats",currentChatId,"messages",selectedMsgId));
            }
        };
        
        // Block Functionality
        window.toggleBlock = async () => {
            if(!currentChatUid) return;
            el('chat-menu').style.display = 'none';
            const userRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(userRef);
            const blockedList = snap.data().blocked || [];
            
            if (blockedList.includes(currentChatUid)) {
                // Unblock
                await updateDoc(userRef, { blocked: arrayRemove(currentChatUid) });
                showPopup("Unblocked", "You can now message this user.");
            } else {
                // Block
                await updateDoc(userRef, { blocked: arrayUnion(currentChatUid) });
                showPopup("Blocked", "You will no longer receive messages from this user.");
            }
            // Refresh Chat View logic
            openChat(currentChatUid);
        };

        // --- NEW: TRIGGER NOTIFICATION (Optimized) ---
        async function triggerNotification(targetUid, msgText) {
            try {
                // 1. Get Recipient Data to find their OneSignal ID
                const docSnap = await getDoc(doc(db, "users", targetUid));
                if (docSnap.exists()) {
                    const rData = docSnap.data();
                    if (rData.oneSignalId) {
                        // 2. Call Vercel API
                        await fetch('/api/notify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userIds: [rData.oneSignalId],
                                title: userData.name, // "User Name"
                                message: msgText,
                                url: window.location.href // Opens the app
                            })
                        });
                    }
                }
            } catch (err) {
                console.error("Notify failed", err); // Fail silently so chat doesn't break
            }
        }

        window.sendMsg = async () => {
            const t = el('chat-input').value.trim();
            // Double check block status
            if(el('chat-footer').classList.contains('hidden')) return; 

            if(t) {
                el('chat-input').value='';
                
                // 1. Save to Firebase
                await addDoc(collection(db,"chats",currentChatId,"messages"),{ 
                    text:t, sender:currentUser.uid, timestamp:serverTimestamp(), read:false, type:'text' 
                });

                // 2. Trigger Notification
                triggerNotification(currentChatUid, t);
            }
        };

        window.sendChatImage = async (inp) => {
            if(el('chat-footer').classList.contains('hidden')) return;

            if(inp.files[0]) {
                showBar();
                const url = await uploadImg(inp.files[0]);
                if(url) {
                    // 1. Save to Firebase
                     await addDoc(collection(db,"chats",currentChatId,"messages"),{ 
                        imageUrl:url, sender:currentUser.uid, timestamp:serverTimestamp(), read:false, type:'image', text:'' 
                    });

                    // 2. Trigger Notification
                    triggerNotification(currentChatUid, "Sent an image ");
                }
                inp.value = '';
                hideBar();
            }
        };

        // --- SEARCH & FRIENDS (FIXED: Show users on load) ---
        async function loadHome() {
             const sBox = el('slider-box'); sBox.innerHTML='';
             const sSnaps = await getDocs(collection(db,"sliders"));
             let slides = [];
             sSnaps.forEach(d => slides.push(d.data()));
             
             if(slides.length > 0) {
                 slides.forEach((s, idx) => {
                     sBox.innerHTML += `<img src="${s.imageUrl}" class="slide ${idx===0?'active':''}" loading="lazy">`;
                 });
                 let curSlide = 0;
                 if(slides.length > 1) {
                     setInterval(() => {
                         const els = document.querySelectorAll('.slide');
                         els[curSlide].classList.remove('active');
                         curSlide = (curSlide + 1) % els.length;
                         els[curSlide].classList.add('active');
                     }, 4000);
                 }
             } else {
                 sBox.innerHTML = `<div class="center" style="height:100%;color:#777;">No News</div>`;
             }
             
             const aBox = el('ann-list'); aBox.innerHTML='';
             (await getDocs(query(collection(db,"announcements"),limit(5)))).forEach(d=>{
                 aBox.innerHTML+=`<div style="background:var(--bg-card);padding:15px;margin-bottom:8px;border-radius:12px;border:1px solid var(--border);color:var(--text-sec);box-shadow:var(--shadow-sm);">${d.data().text}</div>`;
             });

             // ** FIX: Load Users Automatically **
             searchUsers();
        }
        
        window.searchUsers = async () => {
            const t = el('search-input').value.toLowerCase();
            const box = el('search-list'); box.innerHTML='';
            
            // ** FIX: Handle Empty Search - Show recent users **
            let q;
            if(t.length < 1) {
                // If empty, fetch last 20 users
                q = query(collection(db,"users"), limit(20));
            } else {
                q = query(collection(db,"users"), limit(20));
            }

            const snaps = await getDocs(q);
            snaps.forEach(d => {
                const u = d.data();
                // Filter Logic
                if(u.uid !== currentUser.uid) {
                    // Check Search Term OR if Search is Empty
                    if(t.length === 0 || u.name.toLowerCase().includes(t) || u.preranaId.includes(t)) {
                        const isFr = userData.friends.includes(u.uid);
                        box.innerHTML += `
                            <div class="user-row">
                                <div class="avatar">${u.photoURL ? `<img src="${u.photoURL}">` : u.name[0]}</div>
                                <div style="flex:1;">
                                    <div style="color:var(--text-main);font-weight:600;">${u.name}</div>
                                    <div style="color:var(--text-sec);font-size:12px;">ID: ${u.preranaId}</div>
                                </div>
                                ${isFr?'<span style="font-size:12px;color:var(--success);margin-right:10px;">Friend</span>':`<button class="btn-grad" style="width:auto;padding:6px 16px;font-size:12px;" onclick="sendReq('${u.uid}')">Connect</button>`}
                            </div>`;
                    }
                }
            });
        };
        window.sendReq = async(uid)=>{ await updateDoc(doc(db,"users",uid),{requests:arrayUnion(currentUser.uid)}); showPopup("Sent","Friend Request Sent"); };

        async function loadFriends() {
             const l = el('friends-list'); l.innerHTML='';
             if(!userData.friends.length) l.innerHTML='<p style="text-align:center;margin-top:20px;color:var(--text-sec);">No friends added yet.</p>';
             for(const uid of userData.friends) {
                 const uDoc = await getDoc(doc(db,"users",uid));
                 if(uDoc.exists()) {
                     const u = uDoc.data();
                     l.innerHTML += `
                         <div class="user-row" onclick="openChat('${uid}')">
                            <div class="avatar">${u.photoURL ? `<img src="${u.photoURL}">` : u.name[0]}</div>
                            <div>
                                <div style="color:var(--text-main);font-weight:600;">${u.name}</div>
                                <div style="color:var(--text-sec);font-size:12px;">Tap to chat</div>
                            </div>
                         </div>`;
                 }
             }
        }

        // --- SETTINGS & INFO ---
        window.toggleSettings = (o) => {
            if(o) { toggleMenu(); el('view-settings').classList.add('open'); }
            else el('view-settings').classList.remove('open');
        };
        window.updatePfp = async(i)=>{ 
            if(i.files[0]){
                showBar(); 
                const u=await uploadImg(i.files[0]); 
                if(u){ 
                    await updateDoc(doc(db,"users",currentUser.uid),{photoURL:u}); 
                    showPopup("Done","Profile Photo Updated");
                    userData.photoURL = u; 
                    initApp();
                } 
                hideBar();
            } 
        };
        window.updateField = (f,v) => updateDoc(doc(db,"users",currentUser.uid),{[f]:v});

        window.openAbout = () => showPopup("About Prerana Go", "Prerana Go v4.0\n\nDeveloped by Vivek Dalvi.\n\nPrerana Go is a Next-Gen Student Connect platform designed to bridge the communication gap between students efficiently.\n\nFeatures:\n Real-time Encrypted Chat\n Status Stories (24h expiry)\n Campus News Slider\n Friend Discovery System\n Cyberpunk/Light Mode\n\nBuilt with Google Firebase and AI-enhanced algorithms.");
        
        window.openPrivacy = () => showPopup("Privacy Policy & Terms", "1. Data Storage:\nYour messages, profile data, and interactions are stored securely on Google Cloud Firestore (Firebase). We prioritize data integrity.\n\n2. Media Hosting:\nImages shared in posts, chats, or statuses are hosted on secure servers (ImgBB/Firebase Storage).\n\n3. User Privacy:\nWe do not share your personal data with third-party advertisers. Your 'Auto-Delete' preference in settings strictly removes messages locally and from the server after the set duration.\n\n4. Community Guidelines:\nHarassment, hate speech, or sharing inappropriate content will result in an immediate account ban.\n\n5. Prerana ID:\nYour unique ID is public to allow other students to find you.");

        // --- UTILS ---
        async function uploadImg(f) {
            const fd = new FormData(); fd.append("image",f);
            try { const r=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:'POST',body:fd}); const d=await r.json(); return d.data.url; }
            catch(e){ showPopup("Upload Failed","Check your internet connection."); return null; }
        }

    </script>
</body>
</html>
